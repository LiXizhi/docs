## 方块材质

Paracraft中的材质（Materials） 定义了场景中对象的表面属性。从广义上来讲，你可以将材质视为涂在方块上用来控制其视觉外观的"涂料"。

更具体地说，材质能准确地告诉引擎某个表面应该如何与场景中的光源交互。材质定义了表面的各种特性，包括颜色、反射率、粗糙度、透明度、自发光等。

![](https://api.keepwork.com/ts-storage/siteFiles/24650/raw#1669776110224image.png)

### 着色管线概述
在渲染管线中，着色器是定义每个顶点或像素应该如何渲染的程序。Paracraft中的着色器用高级着色语言（HLSL）编写。然后，将着色器代码转换为GPU硬件可以执行的一系列汇编语言指令。最终像素颜色就这样输出到了你的显示器。

在Paracraft中，你无需编写HLSL代码即可为你的项目创建着色器。你在名为材质编辑器（Material Editor）的可视化界面中创建名为材质（Materials）的物品。
我们默认使用通用Shader管线参数，见后文。

### 材质

> 在工具菜单下，我们选择纹理材质对象

![](https://api.keepwork.com/ts-storage/siteFiles/24648/raw#1669772271543image.png)


### 通用着色管线参数
Paracraft支持用户自定义HLSL着色管线，但是默认情况下我们使用下面的通用着色管线参数。未来，在不同类型的方块（例如雪，土地，彩色方块，金属方块）上应用材质，可能会自动启动不同的默认着色管线。但是目前我们主要使用如下的基于高光的着色管线 (Specular WorkFlow)。

- 材质ID：0代表空气，-1代表没有材质， 1到65535代表材质的ID。 方块一般有6个面，每个面都可以被赋予一个材质ID，默认值为-1，也就是没有外部材质。如果我们改变了某个材质ID的其他属性， 场景中所有与之关联的面都会随之更改。每个世界可以定义属于自己的材质属性，配置文件在世界目录下的 blockWorld.lastsave/blockMaterial.xml 中。
- 名称：只是便于记忆和搜索的名字
- 颜色(BaseColor)：也叫做漫反射的基础颜色
- UV: 由四个浮点数值构成 {TilingU, TilingV, OffsetX, OffsetY}。 TilingU, TilingV代表材质中用到的所有贴图跨越多少个方块。默认值为1,1。这个数值一般为整数，但也可以是浮点数。注意方块的材质采用了每个方块的世界坐标自动做UV映射，并没有使用方块自带的UV坐标。 后两个参数OffsetX, OffsetY代表在世界坐标系下的UV映射的位置，我们可以使用它将材质中的贴图的原点移动到场景中的任意位置。 
    - 注意1: 目前暂时不支持UV的旋转。 
    - 注意2: 材质不等于贴图，如果你希望将一张图摆放到场景中的不同位置，可以创建多个参数相同，只是UV坐标不同的材质。 
- 漫反射贴图 （DiffuseTexture）: 这个是最常用的贴图，代表物体本来的颜色。实际上BaseColor x DiffuseTexture是物体最终的漫反射颜色。
- 高光（Specular）：记住，几乎所有的材质都会有一些高光。
- 法线贴图 (NormalTexture): RGB代表法线，这个一般是一张偏蓝色的图。
    - 注意：Paracraft中， 我们可以将物品的粗糙度，也就是粗糙贴图（Roughness）放到法线贴图的Alpha通道中。 
- 自发光颜色 (EmissiveColor)：RGBA颜色。如果物体不自发光，Alpha值应该是0, 否则应该为1. 当Alpha不是0时，我们还可以使用一张自发光贴图精确控制材质的哪些地方可以自发光。自发光一般是制作夜晚的霓虹灯的效果。
- 自发光贴图 (EmissiveTexture): 物体的自发光度的最终颜色其实是 EmissiveColor x EmissiveTexture决定的。其中alpha的数值代表自发光的亮度。也就是Alpha=0的地方完全没有自发光， Alpha=1则等于一个夜晚点光源中心点的亮度。
- 半透明 (Opacity)：目前暂时没有实现。


更多内容请看后面的PBR材质属性

### 关于性能
性能分为空间和时间。 和默认的方块像素风格的贴图不一样， 我们官方的每个材质大都采用了高清的PBR（基于物理的渲染）材质。每个材质都包含了2-4张高清贴图（1024或512pixels）。 也就是空间上，一个PBR材质相当于200-600个普通方块的材质大小。 PBR材质一般用于表达一些写实风格的3D场景，主要用于对性能没有太多限制的场景，例如视频制作、家庭PC、VR等。

一般来说材质不等于贴图，也就是说不同的材质间可以共享贴图。场景中材质的数量基本没有限制，但是我们要注意贴图的使用量，因为贴图比较占用显存，另外如果在一个小的区域使用了大量不同的贴图，显卡频繁切换贴图也会带来一些额外的开销。一般在可见范围内10-20张PBR材质贴图是没有问题的。  


## PBR材质（基于物理的材质）是什么意思？
基于物理的渲染（Physically based rendering） (PBR)意味着表面接近光线在真实世界的表现方式，而不是我们直观以为的应有方式。 相较于完全依赖美术师直觉来设置参数的着色工作流程，遵守PBR原则的材质更准确，并且通常看起来更自然。

基于物理的材质在所有光照环境中都能有同等程度的良好表现。 此外，材质值的复杂程度和相互依赖程度可以降低，这样材质创建工作流程对于用户更加友好。 这些优点甚至适用于非真实感渲染，正如Pixar和Disney的电影中所展现的那样。

> 建议网上搜索并阅读PBR的相关文档



## PBR材质属性

### 基础颜色 BaseColor
基础颜色定义了材质的总体颜色。 "基础颜色"输入接受 Vector3 (RGB) 值，其中每个通道自动限制在0到1之间。如果取自真实世界，这是使用极化筛选器（极化会删除对齐时非金属的高光度）拍照时的颜色。

#### 为非金属测量的基础颜色值（仅限强度）：

木炭 0.02 | 新沥青 0.02 | 旧沥青 0.08 | 裸土 0.13 | 青草 0.21 | 沙漠沙 0.36 | 新混凝土 0.51 | 海洋冰 0.56 | 新雪 0.81

#### 为金属测量的基础颜色：
基础颜色(R, G, B)

铁 (0.560, 0.570, 0.580) | 银 (0.972, 0.960, 0.915) | 铝 (0.913, 0.921, 0.925) | 金 (1.000, 0.766, 0.336) | 铜 (0.955, 0.637, 0.538) | 铬 (0.550, 0.556, 0.554) | 镍 (0.660, 0.609, 0.526) | 钛 (0.542, 0.497, 0.449) | 钴 (0.662, 0.655, 0.634) | 铂 (0.672, 0.637, 0.585) |

### 粗糙度 Roughness
"粗糙度"输入控制了材质表面有多粗糙或光滑。 在材质中，这表现为反射在材质上看起来有多尖锐或模糊。
粗糙材质会沿比光滑材质更多的方向反射光线，这样产生的是漫反射，有时很细微。光滑表面会更均匀地反射光线，这样产生的是清晰、集中的反射或镜面高光。
粗糙度为0（光滑）会产生镜面反射。粗糙度为1（粗糙）会产生漫反射或无光泽的表面。

![](https://api.keepwork.com/ts-storage/siteFiles/24649/raw#1669774507152image.png)

0到1之间的粗糙度值。顶部为非金属，底部为金属。 

粗糙度需要写到法线贴图的Alpha通道中，以精确控制材质上的粗糙度。 粗糙度贴图上的深色区域在材质上看起来像镜子，而浅色区域则比较粗糙，看起来反射度较低。

### 高光度 Specular

"高光度"输入接受0到1之间的值，并控制表面反射多少高光。"高光度"值为0表示完全不反射。"高光度"值为1表示完全反射。
几乎所有的材质都会有一些高光， 包括漫反射程度很高的材质。

### 使用JPG，PNG还是DDS存储贴图文件？

PNG、JPEG等作为贴图的。这些贴图虽然在磁盘上以较高的压缩比进行存放，然而GPU并不能直接使用这些格式，所以当它们被展开到内存（包括显卡内存）上的时候，是以非压缩形式存放的。

以一张2Kx2K分辨率的32bit色深（R8G8B8A8，即8bit红色+8bit绿色+8bit蓝色+8bit透明通道）的贴图为例，每个像素是32bit=4字节，2Kx2K（2048x2048）就是大约400万像素，所以一共就是1600万字节，也就是16MB左右。

这对于我们这种只有几个物体十来张贴图的练手项目来说也许还不算太大的问题，然而在一般的游戏当中，即便进行了比较好的场景管理，内存当中“热待命”的场景对象（严格来说，材质）数量也常常在百种以上。按照常见的渲染手法，通常一种材质会使用到3张以上的贴图（基色，法线，以及其它）。在这种情况下，这些贴图所占的空间就十分可观了。

通常来说，对于一款商业游戏，贴图是内存占用的大户。以GTA V早期版本为例，总共4GB左右的内存预算当中，大约2GB多是贴图。剩下的不到一半的空间当中，Render Targets又刨去200MB左右，余下的差不多1GB用于其它的所有。

综合以上原因，各家显卡厂商以及基础软件商在过去的几十年当中开发了一系列面向图形显卡硬件的图像压缩格式。这些格式相对于JPEG/PNG等存储压缩格式来说往往压缩比比较低，但是其对GPU硬件友好，适应GPU的访存模式。

下面是比较常见的，也是业界比较多使用的一些贴图压缩格式：

DXT1/DXT3/DXT5（BC1/BC2/BC3）
- DXT1用8字节编码每个4x4图素块。其中2个字节（16bit）用来存储颜色1（R5G6B5），2个字节用了存储颜色2，剩下4个字节（32bit）分给每个图素，就是每个图素是2个bit（用来索引4色调色板）。4色当中两个颜色为颜色1和颜色2，颜色3和4为颜色1和2连线的等间隔内插值点（1/3位置和2/3位置）。不支持透明通道，或者支持1bit的透明通道（这个1bit并没有被实际存储，它是通过被选定的那两个色差最大的颜色的大小排列来表示的。比如，选定的两个颜色A和B，假设A<B（按照单纯8bit无符号数比较），那么就可以规定按照A然后B的顺序存储就表示Alpha通道为0，按照B然后A的顺序存储就表示Alpha通道为1。
    - 游戏当中的大部分贴图都是不带透明通道的，或者仅仅是需要镂空（也叫蒙板，遮罩，如树叶，铁丝网等）所以DXT1可以说是游戏当中非常主流的一种格式。
    - DXT1的一个主要问题是，它的调色板存储采用R5G6B5（16bit）的色深。这就表示，在如今普遍24bit以上色深的时代，即便图片是纯色，也可能发生偏色。
- DXT3格式则在DXT1格式的基础上增加了对于透明通道的存储。实际上其内部是将RGB三个通道按照DXT1存储，将A通道另外单独提取出来，按照4bit的索引+16色调色板进行存储。所以DXT3格式在DXT1的基础上带宽翻一倍，是8bit每个图素。DXT3的特点是A通道的16色调色板是真的（灰阶）调色板，每个值都能单独指定，而不是通过两个值插值得到。所以对于A通道值比较离散但是种类有限（<16种）的情况比较适用。压缩比1/4。
- DXT5与DXT3格式类似，只不过在Alpha通道的处理上不是采用固定的16色调色板，而是采用线性插值（Alpha通道宽度保留8bit，3bit索引所以是8色（灰度）调色板）。因此DXT5可以得到更好的Alpha过渡，但是也因为其线性插值的原因，难以得到锐利的Alpha变化。压缩比1/4。

## 参考资料
- 免费PBR材质库： https://3dtextures.me/
- DXT1, DXT3, DXT5贴图：https://zhuanlan.zhihu.com/p/533566322
- https://cglearn.eu/pub/advanced-computer-graphics/physically-based-shading